import{s as Qe,p as G,a as ke,f as _e,M as Xe,d as oe,c as Ce,g as we,h as ye,j as ie,i as Re,r as ce,u as Ze,Y as Q,w as X,P as xe,o as $e,t as V}from"../chunks/scheduler.4a29073b.js";import{S as et,i as tt,f as Z,b as Ee,d as ve,m as Pe,a as Oe,t as Ne,e as Ae}from"../chunks/index.10afcf02.js";import{g as ot}from"../chunks/globals.7f7f1b26.js";import{a as U}from"../chunks/Toaster.svelte_svelte_type_style_lang.622c7c00.js";import"../chunks/singletons.5c93d3e3.js";import{p as st}from"../chunks/stores.455bd7d1.js";import{f as be,d as Be,m as nt,c as rt,i as lt,W as at,e as ue,a as Le,L as De,O as He,j as it}from"../chunks/index.3cc0610f.js";import{v as Je,s as qe,a as je}from"../chunks/index.1bdba4f5.js";import{i as ct,c as We}from"../chunks/index.0b44bc8f.js";import{e as ut,c as pe,y as Te}from"../chunks/index.56297a3e.js";import{c as pt,d as ft}from"../chunks/helpers.3b714ceb.js";import{N as dt,M as mt}from"../chunks/Navbar.35d053ca.js";import{M as gt}from"../chunks/jspdf.es.min.fce916a1.js";import"../chunks/create.76372bae.js";const{document:Ue}=ot;function ht(s){var ge;let x,o,h,t,_,R,O,N,b,W,k,D,S,C,H,M,d,A,se,T,$,ee;Ue.title=x=`\r
		`+(s[8]?`${s[8].length>30?`${s[8].slice(0,30)}...`:s[8]} | ${s[14]}`:`${s[14]}`)+`\r
	`;function J(n){s[23](n)}function i(n){s[24](n)}let a={title:s[8],shareEnabled:s[11].length>0,chat:s[7],initNewChat:s[16]};s[0]!==void 0&&(a.selectedModels=s[0]),s[4]!==void 0&&(a.showModelSelector=s[4]),t=new dt({props:a}),G.push(()=>Z(t,"selectedModels",J)),G.push(()=>Z(t,"showModelSelector",i));function fe(n){s[25](n)}function Y(n){s[26](n)}function Se(n){s[27](n)}let z={chatId:s[12],selectedModels:s[0],selectedModelfiles:s[6],processing:_t,bottomPadding:s[10].length>0,sendPrompt:s[18],continueGeneration:s[21],regenerateResponse:s[20]};s[1]!==void 0&&(z.history=s[1]),s[11]!==void 0&&(z.messages=s[11]),s[2]!==void 0&&(z.autoScroll=s[2]),k=new gt({props:z}),G.push(()=>Z(k,"history",fe)),G.push(()=>Z(k,"messages",Y)),G.push(()=>Z(k,"autoScroll",Se));function de(n){s[30](n)}function me(n){s[31](n)}function Me(n){s[32](n)}let ne={suggestionPrompts:((ge=s[5])==null?void 0:ge.suggestionPrompts)??s[13].default_prompt_suggestions,messages:s[11],submitPrompt:s[17],stopResponse:s[19]};return s[10]!==void 0&&(ne.files=s[10]),s[9]!==void 0&&(ne.prompt=s[9]),s[2]!==void 0&&(ne.autoScroll=s[2]),M=new mt({props:ne}),G.push(()=>Z(M,"files",de)),G.push(()=>Z(M,"prompt",me)),G.push(()=>Z(M,"autoScroll",Me)),{c(){o=ke(),h=_e("div"),Ee(t.$$.fragment),O=ke(),N=_e("div"),b=_e("div"),W=_e("div"),Ee(k.$$.fragment),H=ke(),Ee(M.$$.fragment),this.h()},l(n){Xe("svelte-1123lr8",Ue.head).forEach(oe),o=Ce(n),h=we(n,"DIV",{class:!0});var E=ye(h);ve(t.$$.fragment,E),O=Ce(E),N=we(E,"DIV",{class:!0});var I=ye(N);b=we(I,"DIV",{class:!0,id:!0});var B=ye(b);W=we(B,"DIV",{class:!0});var te=ye(W);ve(k.$$.fragment,te),te.forEach(oe),B.forEach(oe),H=Ce(I),ve(M.$$.fragment,I),I.forEach(oe),E.forEach(oe),this.h()},h(){ie(W,"class","h-full w-full flex flex-col pt-2 pb-4"),ie(b,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),ie(b,"id","messages-container"),ie(N,"class","flex flex-col flex-auto"),ie(h,"class","h-screen max-h-[100dvh] w-full flex flex-col")},m(n,m){Re(n,o,m),Re(n,h,m),Pe(t,h,null),ce(h,O),ce(h,N),ce(N,b),ce(b,W),Pe(k,W,null),s[28](b),ce(N,H),Pe(M,N,null),T=!0,$||(ee=Ze(b,"scroll",s[29]),$=!0)},p(n,m){var te;(!T||m[0]&16640)&&x!==(x=`\r
		`+(n[8]?`${n[8].length>30?`${n[8].slice(0,30)}...`:n[8]} | ${n[14]}`:`${n[14]}`)+`\r
	`)&&(Ue.title=x);const E={};m[0]&256&&(E.title=n[8]),m[0]&2048&&(E.shareEnabled=n[11].length>0),m[0]&128&&(E.chat=n[7]),!_&&m[0]&1&&(_=!0,E.selectedModels=n[0],Q(()=>_=!1)),!R&&m[0]&16&&(R=!0,E.showModelSelector=n[4],Q(()=>R=!1)),t.$set(E);const I={};m[0]&4096&&(I.chatId=n[12]),m[0]&1&&(I.selectedModels=n[0]),m[0]&64&&(I.selectedModelfiles=n[6]),m[0]&1024&&(I.bottomPadding=n[10].length>0),!D&&m[0]&2&&(D=!0,I.history=n[1],Q(()=>D=!1)),!S&&m[0]&2048&&(S=!0,I.messages=n[11],Q(()=>S=!1)),!C&&m[0]&4&&(C=!0,I.autoScroll=n[2],Q(()=>C=!1)),k.$set(I);const B={};m[0]&8224&&(B.suggestionPrompts=((te=n[5])==null?void 0:te.suggestionPrompts)??n[13].default_prompt_suggestions),m[0]&2048&&(B.messages=n[11]),!d&&m[0]&1024&&(d=!0,B.files=n[10],Q(()=>d=!1)),!A&&m[0]&512&&(A=!0,B.prompt=n[9],Q(()=>A=!1)),!se&&m[0]&4&&(se=!0,B.autoScroll=n[2],Q(()=>se=!1)),M.$set(B)},i(n){T||(Oe(t.$$.fragment,n),Oe(k.$$.fragment,n),Oe(M.$$.fragment,n),T=!0)},o(n){Ne(t.$$.fragment,n),Ne(k.$$.fragment,n),Ne(M.$$.fragment,n),T=!1},d(n){n&&(oe(o),oe(h)),Ae(t),Ae(k),s[28](null),Ae(M),$=!1,ee()}}}let _t="";function wt(s,x,o){let h,t,_,R,O,N,b,W;X(s,be,e=>o(12,h=e)),X(s,Be,e=>o(36,t=e)),X(s,nt,e=>o(38,R=e)),X(s,rt,e=>o(13,O=e)),X(s,st,e=>o(39,N=e)),X(s,lt,e=>o(22,b=e)),X(s,at,e=>o(14,W=e));const k=xe("i18n");X(s,k,e=>o(37,_=e));let D=!1,S=!0,C,H=null,M=!0,d=[""],A=null,se={},T=null,$="",ee="",J=[],i=[],a={messages:{},currentId:null};$e(async()=>{await fe()});const fe=async()=>{var p;H!==null&&(await We(localStorage.token,H),H=null),window.history.replaceState(a.state,"","/"),await be.set(""),o(2,S=!0),o(8,$=""),o(11,i=[]),o(1,a={messages:{},currentId:null}),N.url.searchParams.get("models")?o(0,d=(p=N.url.searchParams.get("models"))==null?void 0:p.split(",")):t!=null&&t.models?o(0,d=t==null?void 0:t.models):O!=null&&O.default_models?o(0,d=O==null?void 0:O.default_models.split(",")):o(0,d=[""]),o(0,d=d.map(f=>R.map(l=>l.id).includes(f)?f:""));let e=JSON.parse(localStorage.getItem("settings")??"{}");Be.set({...e});const c=document.getElementById("chat-textarea");setTimeout(()=>c==null?void 0:c.focus(),0)},Y=()=>{C&&o(3,C.scrollTop=C.scrollHeight,C)},Se=async(e,c=null)=>{if(console.log("submitPrompt",h),o(0,d=d.map(p=>R.map(f=>f.id).includes(p)?p:"")),d.includes(""))U.error(_.t("Model not selected"));else if(i.length!=0&&i.at(-1).done!=!0)console.log("wait");else if(J.length>0&&J.filter(p=>p.upload_status===!1).length>0)U.error(_.t("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready."));else{document.getElementById("chat-textarea").style.height="";let p=Je(),f={id:p,parentId:i.length!==0?i.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:J.length>0?J:void 0,timestamp:Math.floor(Date.now()/1e3)};o(1,a.messages[p]=f,a),o(1,a.currentId=p,a),i.length!==0&&a.messages[i.at(-1).id].childrenIds.push(p),await V(),i.length==1&&(t.saveChatHistory??!0?(o(7,T=await ut(localStorage.token,{id:h,title:_.t("New Chat"),models:d,system:t.system??void 0,options:{...t.options??{}},messages:i,history:a,tags:[],timestamp:Date.now()})),await ue.set(await pe(localStorage.token)),await be.set(T.id)):await be.set("local"),await V()),o(9,ee=""),o(10,J=[]),await z(e,p)}},z=async(e,c)=>{const p=JSON.parse(JSON.stringify(h));await Promise.all(d.map(async f=>{const l=R.filter(g=>g.id===f).at(0);if(l){let g=Je(),w={parentId:c,id:g,childrenIds:[],role:"assistant",content:"",model:l.id,timestamp:Math.floor(Date.now()/1e3)};o(1,a.messages[g]=w,a),o(1,a.currentId=g,a),c!==null&&o(1,a.messages[c].childrenIds=[...a.messages[c].childrenIds,g],a),l!=null&&l.external?await me(l,e,g,p):l&&await de(l,e,g,p)}else U.error(_.t("Model {{modelId}} not found",{modelId:f}))})),await ue.set(await pe(localStorage.token))},de=async(e,c,p,f)=>{var F;e=e.id;const l=a.messages[p];await V(),Y();const g=[t.system?{role:"system",content:t.system}:void 0,...i].filter(u=>u).map((u,v,le)=>{var r;const L={role:u.role,content:le.length-2!==v?u.content:(u==null?void 0:u.raContent)??u.content},q=(r=u.files)==null?void 0:r.filter(P=>P.type==="image").map(P=>P.url.slice(P.url.indexOf(",")+1));return q&&q.length>0&&u.role==="user"&&(L.images=q),L});let w=-1;g.forEach((u,v)=>{u.images&&(w=v)}),g.forEach((u,v)=>{v!==w&&delete u.images});const K=i.filter(u=>(u==null?void 0:u.files)??null).map(u=>u.files.filter(v=>v.type==="doc"||v.type==="collection")).flat(1),[y,re]=await ct(localStorage.token,{model:e,messages:g,options:{...t.options??{}},format:t.requestFormat??void 0,keep_alive:t.keepAlive??void 0,docs:K.length>0?K:void 0});if(y&&y.ok){console.log("controller",re);const u=y.body.pipeThrough(new TextDecoderStream).pipeThrough(qe(`
`)).getReader();for(;;){const{value:v,done:le}=await u.read();if(le||D||f!==h){l.done=!0,o(11,i),o(1,a),D&&(re.abort("User: Stop Response"),await We(localStorage.token,H)),H=null;break}try{let L=v.split(`
`);for(const q of L)if(q!==""){console.log(q);let r=JSON.parse(q);if("detail"in r)throw r;if("id"in r)console.log(r),H=r.id;else if(r.done==!1){if(l.content==""&&r.message.content==`
`)continue;l.content+=r.message.content,o(11,i),o(1,a)}else{if(l.done=!0,l.content==""&&(l.error=!0,l.content="Oops! No text generated from Ollama, Please try again."),l.context=r.context??null,l.info={total_duration:r.total_duration,load_duration:r.load_duration,sample_count:r.sample_count,sample_duration:r.sample_duration,prompt_eval_count:r.prompt_eval_count,prompt_eval_duration:r.prompt_eval_duration,eval_count:r.eval_count,eval_duration:r.eval_duration},o(11,i),o(1,a),t.notificationEnabled&&!document.hasFocus()){const P=new Notification(A?`${A.title.charAt(0).toUpperCase()+A.title.slice(1)}`:`${e}`,{body:l.content,icon:(A==null?void 0:A.imageUrl)??`${Le}/static/favicon.png`})}t.responseAutoCopy&&je(l.content),t.responseAutoPlayback&&(await V(),(F=document.getElementById(`speak-button-${l.id}`))==null||F.click())}}}catch(L){console.log(L),"detail"in L&&U.error(L.detail);break}S&&Y()}h==f&&(t.saveChatHistory??!0)&&(o(7,T=await Te(localStorage.token,f,{messages:i,history:a})),await ue.set(await pe(localStorage.token)))}else{if(y!==null){const u=await y.json();console.log(u),"detail"in u?(U.error(u.detail),l.content=u.detail):(U.error(u.error),l.content=u.error)}else U.error(_.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"})),l.content=_.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"});l.error=!0,l.content=_.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"}),l.done=!0,o(11,i),o(1,a)}if(D=!1,await V(),S&&Y(),i.length==2&&i.at(1).content!==""){window.history.replaceState(a.state,"",`/c/${f}`);const u=await n(c);await m(f,u)}},me=async(e,c,p,f)=>{var K,y,re,F,u,v,le,L,q;const l=a.messages[p],g=i.filter(r=>(r==null?void 0:r.files)??null).map(r=>r.files.filter(P=>P.type==="doc"||P.type==="collection")).flat(1);console.log(g),console.log(e);const w=await pt(localStorage.token,{model:e.id,stream:!0,messages:[t.system?{role:"system",content:t.system}:void 0,...i].filter(r=>r).map((r,P,he)=>{var ae;return{role:r.role,...((ae=r.files)==null?void 0:ae.filter(j=>j.type==="image").length)>0&&r.role==="user"?{content:[{type:"text",text:he.length-1!==P?r.content:(r==null?void 0:r.raContent)??r.content},...r.files.filter(j=>j.type==="image").map(j=>({type:"image_url",image_url:{url:j.url}}))]}:{content:he.length-1!==P?r.content:(r==null?void 0:r.raContent)??r.content}}}),seed:((K=t==null?void 0:t.options)==null?void 0:K.seed)??void 0,stop:((y=t==null?void 0:t.options)==null?void 0:y.stop)??void 0,temperature:((re=t==null?void 0:t.options)==null?void 0:re.temperature)??void 0,top_p:((F=t==null?void 0:t.options)==null?void 0:F.top_p)??void 0,num_ctx:((u=t==null?void 0:t.options)==null?void 0:u.num_ctx)??void 0,frequency_penalty:((v=t==null?void 0:t.options)==null?void 0:v.repeat_penalty)??void 0,max_tokens:((le=t==null?void 0:t.options)==null?void 0:le.num_predict)??void 0,docs:g.length>0?g:void 0},((L=e==null?void 0:e.source)==null?void 0:L.toLowerCase())==="litellm"?`${De}/v1`:`${He}`);if(await V(),Y(),w&&w.ok){const r=w.body.pipeThrough(new TextDecoderStream).pipeThrough(qe(`
`)).getReader();for(;;){const{value:P,done:he}=await r.read();if(he||D||f!==h){l.done=!0,o(11,i),o(1,a);break}try{let ae=P.split(`
`);for(const j of ae)if(j!=="")if(console.log(j),j==="data: [DONE]")l.done=!0,o(11,i),o(1,a);else{let Ie=JSON.parse(j.replace(/^data: /,""));if(console.log(Ie),l.content==""&&Ie.choices[0].delta.content==`
`)continue;l.content+=Ie.choices[0].delta.content??"",o(11,i),o(1,a)}}catch(ae){console.log(ae)}t.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:l.content,icon:`${Le}/static/favicon.png`}),t.responseAutoCopy&&je(l.content),t.responseAutoPlayback&&(await V(),(q=document.getElementById(`speak-button-${l.id}`))==null||q.click()),S&&Y()}h==f&&(t.saveChatHistory??!0)&&(o(7,T=await Te(localStorage.token,f,{messages:i,history:a})),await ue.set(await pe(localStorage.token)))}else{if(w!==null){const r=await w.json();console.log(r),"detail"in r?(U.error(r.detail),l.content=r.detail):"message"in r.error?(U.error(r.error.message),l.content=r.error.message):(U.error(r.error),l.content=r.error)}else U.error(_.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id})),l.content=_.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id});l.error=!0,l.content=_.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id}),l.done=!0,o(11,i),o(1,a)}if(D=!1,await V(),S&&Y(),i.length==2){window.history.replaceState(a.state,"",`/c/${f}`);const r=await n(c);await m(f,r)}},Me=()=>{D=!0,console.log("stopResponse")},ne=async()=>{if(console.log("regenerateResponse"),i.length!=0&&i.at(-1).done==!0){i.splice(i.length-1,1),o(11,i),o(1,a);let e=i.at(-1),c=e.content;await z(c,e.id)}},ge=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(h));if(i.length!=0&&i.at(-1).done==!0){const c=a.messages[a.currentId];c.done=!1,await V();const p=R.filter(f=>f.id===c.model).at(0);p&&(p!=null&&p.external?await me(p,a.messages[c.parentId].content,c.id,e):await de(p,a.messages[c.parentId].content,c.id,e))}else U.error(_.t("Model {{modelId}} not found",{modelId}))},n=async e=>{var c,p,f,l,g;if(((c=t==null?void 0:t.title)==null?void 0:c.auto)??!0){const w=R.find(F=>F.id===d[0]),K=(w==null?void 0:w.external)??!1?((p=t==null?void 0:t.title)==null?void 0:p.modelExternal)??d[0]:((f=t==null?void 0:t.title)==null?void 0:f.model)??d[0],y=R.find(F=>F.id===K);return console.log(y),await ft(localStorage.token,((l=t==null?void 0:t.title)==null?void 0:l.prompt)??_.t("Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title':")+" {{prompt}}",K,e,(y==null?void 0:y.external)??!1?((g=y==null?void 0:y.source)==null?void 0:g.toLowerCase())==="litellm"?`${De}/v1`:`${He}`:`${it}/v1`)}else return`${e}`},m=async(e,c)=>{e===h&&o(8,$=c),(t.saveChatHistory??!0)&&(o(7,T=await Te(localStorage.token,e,{title:c})),await ue.set(await pe(localStorage.token)))};function E(e){d=e,o(0,d)}function I(e){M=e,o(4,M)}function B(e){a=e,o(1,a)}function te(e){i=e,o(11,i),o(1,a)}function Fe(e){S=e,o(2,S)}function Ve(e){G[e?"unshift":"push"](()=>{C=e,o(3,C)})}const Ge=e=>{o(2,S=C.scrollHeight-C.scrollTop<=C.clientHeight+5)};function Ye(e){J=e,o(10,J)}function ze(e){ee=e,o(9,ee)}function Ke(e){S=e,o(2,S)}return s.$$.update=()=>{if(s.$$.dirty[0]&4194305&&o(5,A=d.length===1&&b.filter(e=>e.tagName===d[0]).length>0?b.filter(e=>e.tagName===d[0])[0]:null),s.$$.dirty[0]&4194305&&o(6,se=d.reduce((e,c,p,f)=>{var g;const l=((g=b.filter(w=>w.tagName===c))==null?void 0:g.at(0))??void 0;return{...e,...l&&{[c]:l}}},{})),s.$$.dirty[0]&2)if(a.currentId!==null){let e=[],c=a.messages[a.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?a.messages[c.parentId]:null;o(11,i=e)}else o(11,i=[])},[d,a,S,C,M,A,se,T,$,ee,J,i,h,O,W,k,fe,Se,z,Me,ne,ge,b,E,I,B,te,Fe,Ve,Ge,Ye,ze,Ke]}class Ut extends et{constructor(x){super(),tt(this,x,wt,ht,Qe,{},null,[-1,-1])}}export{Ut as component};
