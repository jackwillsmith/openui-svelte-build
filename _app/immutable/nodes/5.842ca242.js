import{s as tt,a as Pe,e as Ue,M as ot,d as X,c as Ae,i as Be,w as z,P as st,o as nt,p as V,f as we,g as ye,h as be,j as fe,r as pe,u as rt,Y as K,t as B}from"../chunks/scheduler.4a29073b.js";import{S as at,i as lt,a as ae,t as me,c as it,f as Q,b as ve,d as Ce,m as Ee,e as Te,g as ct}from"../chunks/index.10afcf02.js";import{g as ut}from"../chunks/globals.7f7f1b26.js";import{a as U}from"../chunks/Toaster.svelte_svelte_type_style_lang.622c7c00.js";import{g as Se}from"../chunks/navigation.88a60950.js";import{p as ft}from"../chunks/stores.455bd7d1.js";import{d as Re,f as Ie,m as pt,i as dt,W as gt,c as mt,e as de,a as Le,L as De,O as He,j as ht}from"../chunks/index.3cc0610f.js";import{v as Je,s as qe,a as je,h as _t}from"../chunks/index.1bdba4f5.js";import{i as wt,c as We}from"../chunks/index.0b44bc8f.js";import{e as yt,c as ge,y as Ne,x as bt,B as St}from"../chunks/index.56297a3e.js";import{c as It,d as Mt}from"../chunks/helpers.3b714ceb.js";import{N as kt,M as vt}from"../chunks/Navbar.35d053ca.js";import{M as Ct}from"../chunks/jspdf.es.min.fce916a1.js";const{document:Oe}=ut;function Fe(o){var ue;let S,t,s,m,u,f,h,O,k,$,ee,te,H,_,v,R,Z,b,P,le;function L(r){o[26](r)}function ie(r){o[27](r)}let G={title:o[10],chat:o[9],shareEnabled:o[13].length>0,initNewChat:o[25]};o[0]!==void 0&&(G.selectedModels=o[0]),o[6]!==void 0&&(G.showModelSelector=o[6]),t=new kt({props:G}),V.push(()=>Q(t,"selectedModels",L)),V.push(()=>Q(t,"showModelSelector",ie));function J(r){o[28](r)}function i(r){o[29](r)}function l(r){o[30](r)}let oe={chatId:o[14],selectedModels:o[0],selectedModelfiles:o[8],processing:Tt,bottomPadding:o[12].length>0,sendPrompt:o[19],continueGeneration:o[22],regenerateResponse:o[21]};o[1]!==void 0&&(oe.history=o[1]),o[13]!==void 0&&(oe.messages=o[13]),o[3]!==void 0&&(oe.autoScroll=o[3]),k=new Ct({props:oe}),V.push(()=>Q(k,"history",J)),V.push(()=>Q(k,"messages",i)),V.push(()=>Q(k,"autoScroll",l));function W(r){o[33](r)}function Me(r){o[34](r)}function ce(r){o[35](r)}let x={suggestionPrompts:((ue=o[7])==null?void 0:ue.suggestionPrompts)??o[16].default_prompt_suggestions,messages:o[13],submitPrompt:o[18],stopResponse:o[20]};return o[12]!==void 0&&(x.files=o[12]),o[11]!==void 0&&(x.prompt=o[11]),o[3]!==void 0&&(x.autoScroll=o[3]),_=new vt({props:x}),V.push(()=>Q(_,"files",W)),V.push(()=>Q(_,"prompt",Me)),V.push(()=>Q(_,"autoScroll",ce)),{c(){S=we("div"),ve(t.$$.fragment),u=Pe(),f=we("div"),h=we("div"),O=we("div"),ve(k.$$.fragment),H=Pe(),ve(_.$$.fragment),this.h()},l(r){S=ye(r,"DIV",{class:!0});var d=be(S);Ce(t.$$.fragment,d),u=Ae(d),f=ye(d,"DIV",{class:!0});var C=be(f);h=ye(C,"DIV",{class:!0,id:!0});var E=be(h);O=ye(E,"DIV",{class:!0});var A=be(O);Ce(k.$$.fragment,A),A.forEach(X),E.forEach(X),H=Ae(C),Ce(_.$$.fragment,C),C.forEach(X),d.forEach(X),this.h()},h(){fe(O,"class","h-full w-full flex flex-col py-4"),fe(h,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),fe(h,"id","messages-container"),fe(f,"class","flex flex-col flex-auto"),fe(S,"class","min-h-screen max-h-screen w-full flex flex-col")},m(r,d){Be(r,S,d),Ee(t,S,null),pe(S,u),pe(S,f),pe(f,h),pe(h,O),Ee(k,O,null),o[31](h),pe(f,H),Ee(_,f,null),b=!0,P||(le=rt(h,"scroll",o[32]),P=!0)},p(r,d){var he;const C={};d[0]&1024&&(C.title=r[10]),d[0]&512&&(C.chat=r[9]),d[0]&8192&&(C.shareEnabled=r[13].length>0),d[0]&32&&(C.initNewChat=r[25]),!s&&d[0]&1&&(s=!0,C.selectedModels=r[0],K(()=>s=!1)),!m&&d[0]&64&&(m=!0,C.showModelSelector=r[6],K(()=>m=!1)),t.$set(C);const E={};d[0]&16384&&(E.chatId=r[14]),d[0]&1&&(E.selectedModels=r[0]),d[0]&256&&(E.selectedModelfiles=r[8]),d[0]&4096&&(E.bottomPadding=r[12].length>0),!$&&d[0]&2&&($=!0,E.history=r[1],K(()=>$=!1)),!ee&&d[0]&8192&&(ee=!0,E.messages=r[13],K(()=>ee=!1)),!te&&d[0]&8&&(te=!0,E.autoScroll=r[3],K(()=>te=!1)),k.$set(E);const A={};d[0]&65664&&(A.suggestionPrompts=((he=r[7])==null?void 0:he.suggestionPrompts)??r[16].default_prompt_suggestions),d[0]&8192&&(A.messages=r[13]),!v&&d[0]&4096&&(v=!0,A.files=r[12],K(()=>v=!1)),!R&&d[0]&2048&&(R=!0,A.prompt=r[11],K(()=>R=!1)),!Z&&d[0]&8&&(Z=!0,A.autoScroll=r[3],K(()=>Z=!1)),_.$set(A)},i(r){b||(ae(t.$$.fragment,r),ae(k.$$.fragment,r),ae(_.$$.fragment,r),b=!0)},o(r){me(t.$$.fragment,r),me(k.$$.fragment,r),me(_.$$.fragment,r),b=!1},d(r){r&&X(S),Te(t),Te(k),o[31](null),Te(_),P=!1,le()}}}function Et(o){let S,t,s,m;Oe.title=S=`\r
		`+(o[10]?`${o[10].length>30?`${o[10].slice(0,30)}...`:o[10]} | ${o[15]}`:`${o[15]}`)+`\r
	`;let u=o[2]&&Fe(o);return{c(){t=Pe(),u&&u.c(),s=Ue()},l(f){ot("svelte-1123lr8",Oe.head).forEach(X),t=Ae(f),u&&u.l(f),s=Ue()},m(f,h){Be(f,t,h),u&&u.m(f,h),Be(f,s,h),m=!0},p(f,h){(!m||h[0]&33792)&&S!==(S=`\r
		`+(f[10]?`${f[10].length>30?`${f[10].slice(0,30)}...`:f[10]} | ${f[15]}`:`${f[15]}`)+`\r
	`)&&(Oe.title=S),f[2]?u?(u.p(f,h),h[0]&4&&ae(u,1)):(u=Fe(f),u.c(),ae(u,1),u.m(s.parentNode,s)):u&&(ct(),me(u,1,1,()=>{u=null}),it())},i(f){m||(ae(u),m=!0)},o(f){me(u),m=!1},d(f){f&&(X(t),X(s)),u&&u.d(f)}}}let Tt="";function Nt(o,S,t){let s,m,u,f,h,O,k,$;z(o,Re,e=>t(38,s=e)),z(o,Ie,e=>t(14,m=e)),z(o,pt,e=>t(40,f=e)),z(o,ft,e=>t(23,h=e)),z(o,dt,e=>t(24,O=e)),z(o,gt,e=>t(15,k=e)),z(o,mt,e=>t(16,$=e));const ee=st("i18n");z(o,ee,e=>t(39,u=e));let te=!1,H=!1,_=!0,v,R=null,Z=!0,b=[""],P=null,le={},L=null,ie="",G="",J=[],i=[],l={messages:{},currentId:null};const oe=async()=>{if(await Ie.set(h.params.id),t(9,L=await bt(localStorage.token,m).catch(async e=>(await Se("/"),null))),L){await he();const e=L.chat;if(e){console.log(e),t(0,b=((e==null?void 0:e.models)??void 0)!==void 0?e.models:[e.models??""]),t(1,l=((e==null?void 0:e.history)??void 0)!==void 0?e.history:_t(e.messages)),t(10,ie=e.title);let c=JSON.parse(localStorage.getItem("settings")??"{}");return await Re.set({...c,system:e.system??c.system,options:e.options??c.options}),t(3,_=!0),await B(),i.length>0&&t(1,l.messages[i.at(-1).id].done=!0,l),await B(),!0}else return null}},W=()=>{v&&t(4,v.scrollTop=v.scrollHeight,v)},Me=async(e,c=null)=>{if(console.log("submitPrompt",m),b.includes(""))U.error(u.t("Model not selected"));else if(i.length!=0&&i.at(-1).done!=!0)console.log("wait");else if(J.length>0&&J.filter(g=>g.upload_status===!1).length>0)U.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let g=Je(),w={id:g,parentId:i.length!==0?i.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:J.length>0?J:void 0,timestamp:Math.floor(Date.now()/1e3)};t(1,l.messages[g]=w,l),t(1,l.currentId=g,l),i.length!==0&&l.messages[i.at(-1).id].childrenIds.push(g),await B(),i.length==1&&(s.saveChatHistory??!0?(t(9,L=await yt(localStorage.token,{id:m,title:u.t("New Chat"),models:b,system:s.system??void 0,options:{...s.options??{}},messages:i,history:l,timestamp:Date.now()})),await de.set(await ge(localStorage.token)),await Ie.set(L.id)):await Ie.set("local"),await B()),t(11,G=""),t(12,J=[]),await ce(e,g)}},ce=async(e,c)=>{const g=JSON.parse(JSON.stringify(m));await Promise.all(b.map(async w=>{const a=f.filter(y=>y.id===w).at(0);if(a){let y=Je(),I={parentId:c,id:y,childrenIds:[],role:"assistant",content:"",model:a.id,timestamp:Math.floor(Date.now()/1e3)};t(1,l.messages[y]=I,l),t(1,l.currentId=y,l),c!==null&&t(1,l.messages[c].childrenIds=[...l.messages[c].childrenIds,y],l),a!=null&&a.external?await ue(a,e,y,g):a&&await x(a,e,y,g)}else U.error(u.t("Model {{modelId}} not found",{modelId:w}))})),await de.set(await ge(localStorage.token))},x=async(e,c,g,w)=>{var F;e=e.id;const a=l.messages[g];await B(),W();const y=[s.system?{role:"system",content:s.system}:void 0,...i].filter(p=>p).map((p,T,ne)=>{var n;const D={role:p.role,content:ne.length-2!==T?p.content:(p==null?void 0:p.raContent)??p.content},q=(n=p.files)==null?void 0:n.filter(N=>N.type==="image").map(N=>N.url.slice(N.url.indexOf(",")+1));return q&&q.length>0&&p.role==="user"&&(D.images=q),D});let I=-1;y.forEach((p,T)=>{p.images&&(I=T)}),y.forEach((p,T)=>{T!==I&&delete p.images});const Y=i.filter(p=>(p==null?void 0:p.files)??null).map(p=>p.files.filter(T=>T.type==="doc"||T.type==="collection")).flat(1),[M,se]=await wt(localStorage.token,{model:e,messages:y,options:{...s.options??{}},format:s.requestFormat??void 0,keep_alive:s.keepAlive??void 0,docs:Y.length>0?Y:void 0});if(M&&M.ok){console.log("controller",se);const p=M.body.pipeThrough(new TextDecoderStream).pipeThrough(qe(`
`)).getReader();for(;;){const{value:T,done:ne}=await p.read();if(ne||H||w!==m){a.done=!0,t(13,i),t(1,l),H&&(se.abort("User: Stop Response"),await We(localStorage.token,R)),t(5,R=null);break}try{let D=T.split(`
`);for(const q of D)if(q!==""){console.log(q);let n=JSON.parse(q);if("detail"in n)throw n;if("id"in n)console.log(n),t(5,R=n.id);else if(n.done==!1){if(a.content==""&&n.message.content==`
`)continue;a.content+=n.message.content,t(13,i),t(1,l)}else{if(a.done=!0,a.content==""&&(a.error=!0,a.content="Oops! No text generated from Ollama, Please try again."),a.context=n.context??null,a.info={total_duration:n.total_duration,load_duration:n.load_duration,sample_count:n.sample_count,sample_duration:n.sample_duration,prompt_eval_count:n.prompt_eval_count,prompt_eval_duration:n.prompt_eval_duration,eval_count:n.eval_count,eval_duration:n.eval_duration},t(13,i),t(1,l),s.notificationEnabled&&!document.hasFocus()){const N=new Notification(P?`${P.title.charAt(0).toUpperCase()+P.title.slice(1)}`:`${e}`,{body:a.content,icon:(P==null?void 0:P.imageUrl)??`${Le}/static/favicon.png`})}s.responseAutoCopy&&je(a.content),s.responseAutoPlayback&&(await B(),(F=document.getElementById(`speak-button-${a.id}`))==null||F.click())}}}catch(D){console.log(D),"detail"in D&&U.error(D.detail);break}_&&W()}m==w&&(s.saveChatHistory??!0)&&(t(9,L=await Ne(localStorage.token,w,{messages:i,history:l})),await de.set(await ge(localStorage.token)))}else{if(M!==null){const p=await M.json();console.log(p),"detail"in p?(U.error(p.detail),a.content=p.detail):(U.error(p.error),a.content=p.error)}else U.error(u.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"})),a.content=u.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"});a.error=!0,a.content=u.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"}),a.done=!0,t(13,i),t(1,l)}if(H=!1,await B(),_&&W(),i.length==2&&i.at(1).content!==""){window.history.replaceState(l.state,"",`/c/${w}`);const p=await E(c);await A(w,p)}},ue=async(e,c,g,w)=>{var Y,M,se,F,p,T,ne,D,q;const a=l.messages[g],y=i.filter(n=>(n==null?void 0:n.files)??null).map(n=>n.files.filter(N=>N.type==="doc"||N.type==="collection")).flat(1);console.log(y);const I=await It(localStorage.token,{model:e.id,stream:!0,messages:[s.system?{role:"system",content:s.system}:void 0,...i].filter(n=>n).map((n,N,_e)=>{var re;return{role:n.role,...((re=n.files)==null?void 0:re.filter(j=>j.type==="image").length)>0&&n.role==="user"?{content:[{type:"text",text:_e.length-1!==N?n.content:(n==null?void 0:n.raContent)??n.content},...n.files.filter(j=>j.type==="image").map(j=>({type:"image_url",image_url:{url:j.url}}))]}:{content:_e.length-1!==N?n.content:(n==null?void 0:n.raContent)??n.content}}}),seed:((Y=s==null?void 0:s.options)==null?void 0:Y.seed)??void 0,stop:((M=s==null?void 0:s.options)==null?void 0:M.stop)??void 0,temperature:((se=s==null?void 0:s.options)==null?void 0:se.temperature)??void 0,top_p:((F=s==null?void 0:s.options)==null?void 0:F.top_p)??void 0,num_ctx:((p=s==null?void 0:s.options)==null?void 0:p.num_ctx)??void 0,frequency_penalty:((T=s==null?void 0:s.options)==null?void 0:T.repeat_penalty)??void 0,max_tokens:((ne=s==null?void 0:s.options)==null?void 0:ne.num_predict)??void 0,docs:y.length>0?y:void 0},((D=e==null?void 0:e.source)==null?void 0:D.toLowerCase())==="litellm"?`${De}/v1`:`${He}`);if(await B(),W(),I&&I.ok){const n=I.body.pipeThrough(new TextDecoderStream).pipeThrough(qe(`
`)).getReader();for(;;){const{value:N,done:_e}=await n.read();if(_e||H||w!==m){a.done=!0,t(13,i),t(1,l);break}try{let re=N.split(`
`);for(const j of re)if(j!=="")if(console.log(j),j==="data: [DONE]")a.done=!0,t(13,i),t(1,l);else{let ke=JSON.parse(j.replace(/^data: /,""));if(console.log(ke),a.content==""&&ke.choices[0].delta.content==`
`)continue;a.content+=ke.choices[0].delta.content??"",t(13,i),t(1,l)}}catch(re){console.log(re)}s.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:a.content,icon:`${Le}/static/favicon.png`}),s.responseAutoCopy&&je(a.content),s.responseAutoPlayback&&(await B(),(q=document.getElementById(`speak-button-${a.id}`))==null||q.click()),_&&W()}m==w&&(s.saveChatHistory??!0)&&(t(9,L=await Ne(localStorage.token,w,{messages:i,history:l})),await de.set(await ge(localStorage.token)))}else{if(I!==null){const n=await I.json();console.log(n),"detail"in n?(U.error(n.detail),a.content=n.detail):"message"in n.error?(U.error(n.error.message),a.content=n.error.message):(U.error(n.error),a.content=n.error)}else U.error(u.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id})),a.content=u.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id});a.error=!0,a.content=u.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id}),a.done=!0,t(13,i),t(1,l)}if(H=!1,await B(),_&&W(),i.length==2){window.history.replaceState(l.state,"",`/c/${w}`);const n=await E(c);await A(w,n)}},r=()=>{H=!0,console.log("stopResponse")},d=async()=>{if(console.log("regenerateResponse"),i.length!=0&&i.at(-1).done==!0){i.splice(i.length-1,1),t(13,i),t(1,l);let e=i.at(-1),c=e.content;await ce(c,e.id)}},C=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(m));if(i.length!=0&&i.at(-1).done==!0){const c=l.messages[l.currentId];c.done=!1,await B();const g=f.filter(w=>w.id===c.model).at(0);g&&(g!=null&&g.external?await ue(g,l.messages[c.parentId].content,c.id,e):await x(g,l.messages[c.parentId].content,c.id,e))}else U.error(u.t("Model {{modelId}} not found",{modelId}))},E=async e=>{var c,g,w,a,y;if(((c=s==null?void 0:s.title)==null?void 0:c.auto)??!0){const I=f.find(F=>F.id===b[0]),Y=(I==null?void 0:I.external)??!1?((g=s==null?void 0:s.title)==null?void 0:g.modelExternal)??b[0]:((w=s==null?void 0:s.title)==null?void 0:w.model)??b[0],M=f.find(F=>F.id===Y);return console.log(M),await Mt(localStorage.token,((a=s==null?void 0:s.title)==null?void 0:a.prompt)??u.t("Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title':")+" {{prompt}}",Y,e,(M==null?void 0:M.external)??!1?((y=M==null?void 0:M.source)==null?void 0:y.toLowerCase())==="litellm"?`${De}/v1`:`${He}`:`${ht}/v1`)}else return`${e}`},A=async(e,c)=>{e===m&&t(10,ie=c),(s.saveChatHistory??!0)&&(t(9,L=await Ne(localStorage.token,e,{title:c})),await de.set(await ge(localStorage.token)))},he=async()=>await St(localStorage.token,m).catch(async e=>[]);nt(async()=>{(s.saveChatHistory??!0)||await Se("/")});const Ve=async()=>{R!==null&&(await We(localStorage.token,R),t(5,R=null)),Se("/")};function Ge(e){b=e,t(0,b)}function Ye(e){Z=e,t(6,Z)}function ze(e){l=e,t(1,l)}function Ke(e){i=e,t(13,i),t(1,l)}function Qe(e){_=e,t(3,_)}function Xe(e){V[e?"unshift":"push"](()=>{v=e,t(4,v)})}const Ze=e=>{t(3,_=v.scrollHeight-v.scrollTop<=v.clientHeight+5)};function xe(e){J=e,t(12,J)}function $e(e){G=e,t(11,G)}function et(e){_=e,t(3,_)}return o.$$.update=()=>{if(o.$$.dirty[0]&16777217&&t(7,P=b.length===1&&O.filter(e=>e.tagName===b[0]).length>0?O.filter(e=>e.tagName===b[0])[0]:null),o.$$.dirty[0]&16777217&&t(8,le=b.reduce((e,c,g,w)=>{var y;const a=((y=O.filter(I=>I.tagName===c))==null?void 0:y.at(0))??void 0;return{...e,...a&&{[c]:a}}},{})),o.$$.dirty[0]&2)if(l.currentId!==null){let e=[],c=l.messages[l.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?l.messages[c.parentId]:null;t(13,i=e)}else t(13,i=[]);o.$$.dirty[0]&8388608&&h.params.id&&(async()=>{if(await oe()){await B(),t(2,te=!0),window.setTimeout(()=>W(),0);const e=document.getElementById("chat-textarea");e==null||e.focus()}else await Se("/")})()},[b,l,te,_,v,R,Z,P,le,L,ie,G,J,i,m,k,$,ee,Me,ce,r,d,C,h,O,Ve,Ge,Ye,ze,Ke,Qe,Xe,Ze,xe,$e,et]}class Ft extends at{constructor(S){super(),lt(this,S,Nt,Et,tt,{},null,[-1,-1])}}export{Ft as component};
